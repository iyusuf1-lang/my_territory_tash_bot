<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  Territory Tashkent â€” PWA Helper                  â•‘
  â•‘  Bu kodni har bir HTML sahifaning <head> ga qo'shing â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<!-- 1. PWA Meta Tags â€” <head> ichiga qo'shing -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#e94560">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Territory">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

<!-- 2. PWA Install Banner Styles â€” <style> ichiga qo'shing -->
<style>
.pwa-banner {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: linear-gradient(135deg, #16213e, #0d0d1a);
  border-top: 1px solid rgba(233,69,96,0.3);
  padding: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 9999;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 -8px 32px rgba(0,0,0,0.5);
}

.pwa-banner.show {
  transform: translateY(0);
}

.pwa-banner-icon {
  width: 52px; height: 52px;
  background: rgba(233,69,96,0.15);
  border: 1px solid rgba(233,69,96,0.3);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  flex-shrink: 0;
}

.pwa-banner-text {
  flex: 1;
}

.pwa-banner-text strong {
  display: block;
  color: #fff;
  font-size: 0.9rem;
  margin-bottom: 2px;
}

.pwa-banner-text span {
  color: rgba(200,214,229,0.6);
  font-size: 0.75rem;
}

.pwa-install-btn {
  background: #e94560;
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 10px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
}

.pwa-close-btn {
  background: none;
  border: none;
  color: rgba(200,214,229,0.4);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0.2rem;
  flex-shrink: 0;
}
</style>

<!-- 3. PWA Install Banner HTML â€” <body> oxiriga qo'shing -->
<div class="pwa-banner" id="pwaBanner">
  <div class="pwa-banner-icon">ðŸ—º</div>
  <div class="pwa-banner-text">
    <strong>App sifatida o'rnating</strong>
    <span>Offline ishlaydi Â· Tezroq Â· Ikonka paydo bo'ladi</span>
  </div>
  <button class="pwa-install-btn" id="pwaInstallBtn">O'rnatish</button>
  <button class="pwa-close-btn" id="pwaCloseBtn">âœ•</button>
</div>

<!-- 4. PWA Script â€” <body> oxiriga qo'shing -->
<script>
(function() {
  // Service Worker ro'yxatdan o'tkazish
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => {
          console.log('[PWA] SW registered:', reg.scope);

          // Yangi version bo'lsa xabar berish
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateBanner();
              }
            });
          });
        })
        .catch(err => console.warn('[PWA] SW error:', err));
    });

    // SW xabarlarini tinglash
    navigator.serviceWorker.addEventListener('message', (e) => {
      if (e.data?.type === 'SYNC_COMPLETE') {
        console.log('[PWA] Treks synced!');
      }
    });
  }

  // Install prompt ushlab qolish
  let deferredPrompt = null;
  const banner = document.getElementById('pwaBanner');
  const installBtn = document.getElementById('pwaInstallBtn');
  const closeBtn = document.getElementById('pwaCloseBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    // 3 sekunddan keyin banner ko'rsatish
    setTimeout(() => {
      if (!localStorage.getItem('pwa-dismissed')) {
        banner?.classList.add('show');
      }
    }, 3000);
  });

  installBtn?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log('[PWA] Install outcome:', outcome);
    deferredPrompt = null;
    banner?.classList.remove('show');
  });

  closeBtn?.addEventListener('click', () => {
    banner?.classList.remove('show');
    localStorage.setItem('pwa-dismissed', '1');
  });

  // App o'rnatilganini aniqlash
  window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed!');
    banner?.classList.remove('show');
    deferredPrompt = null;
  });

  // Offline/Online holati
  function updateOnlineStatus() {
    const isOnline = navigator.onLine;
    document.body.classList.toggle('offline', !isOnline);
    if (!isOnline) {
      console.log('[PWA] Offline mode');
    }
  }
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();

  // Update banner
  function showUpdateBanner() {
    const updateMsg = document.createElement('div');
    updateMsg.style.cssText = `
      position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
      background: #16213e; border: 1px solid rgba(233,69,96,0.4);
      color: #fff; padding: 0.75rem 1.25rem; border-radius: 12px;
      font-size: 0.85rem; z-index: 9999; cursor: pointer;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    `;
    updateMsg.innerHTML = 'ðŸ”„ Yangi versiya bor! Yangilash uchun bosing';
    updateMsg.onclick = () => window.location.reload();
    document.body.appendChild(updateMsg);
  }
})();
</script>
