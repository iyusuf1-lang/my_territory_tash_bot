<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Territory Map</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; font-family:-apple-system,sans-serif; }

#map { position:absolute; inset:0; z-index:1; }

/* TOP BAR */
#topbar {
  position:absolute; top:0; left:0; right:0;
  z-index:1000;
  background:linear-gradient(180deg,rgba(15,20,40,0.95),rgba(15,20,40,0.7));
  padding:8px 12px;
  display:flex; align-items:center; justify-content:space-between;
}
#topbar-left { display:flex; flex-direction:column; }
#topbar-title { font-size:15px; font-weight:700; color:#e94560; }
#topbar-sub { font-size:11px; color:#aaa; margin-top:1px; }
#topbar-right { display:flex; gap:8px; }

.stat-pill {
  background:rgba(255,255,255,0.1);
  border-radius:12px; padding:4px 10px;
  font-size:12px; color:#fff; font-weight:600;
}

/* BOTTOM BAR */
#bottombar {
  position:absolute; bottom:0; left:0; right:0;
  z-index:1000;
  background:linear-gradient(0deg,rgba(15,20,40,0.95),rgba(15,20,40,0.7));
  padding:8px 10px;
  display:flex; gap:6px;
}
.btn {
  flex:1; padding:9px 4px;
  border:none; border-radius:10px;
  font-size:12px; font-weight:600;
  cursor:pointer; transition:0.15s;
}
.btn:active { transform:scale(0.95); opacity:0.8; }
.btn-red    { background:#e94560; color:#fff; }
.btn-dark   { background:rgba(255,255,255,0.12); color:#fff; }
.btn-active { background:#2ecc71; color:#fff; }

/* LEGEND */
#legend {
  position:absolute; right:10px; top:70px;
  z-index:1000;
  background:rgba(15,20,40,0.88);
  border-radius:10px; padding:8px 12px;
  font-size:11px; color:#fff;
}
#legend div { margin:3px 0; display:flex; align-items:center; gap:6px; }
.ldot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

/* PLAYERS PANEL */
#players-panel {
  position:absolute; left:10px; top:70px;
  z-index:1000;
  background:rgba(15,20,40,0.88);
  border-radius:10px; padding:8px 12px;
  font-size:11px; color:#fff;
  min-width:120px; max-width:160px;
  display:none;
}
#players-panel h4 { font-size:12px; color:#e94560; margin-bottom:6px; }
.player-row { margin:3px 0; }

/* ZONE INFO POPUP */
#zone-info {
  position:absolute; bottom:65px; left:10px; right:10px;
  z-index:1000;
  background:rgba(15,20,40,0.95);
  border:1px solid #e94560;
  border-radius:14px; padding:12px 16px;
  display:none;
}
#zone-info h3 { font-size:14px; color:#fff; margin-bottom:6px; }
#zone-info p  { font-size:12px; color:#bbb; margin:2px 0; }
#zone-close {
  position:absolute; top:8px; right:12px;
  background:none; border:none; color:#aaa;
  font-size:18px; cursor:pointer;
}

/* MY LOCATION pulse */
.my-dot {
  width:14px; height:14px;
  background:#e94560;
  border:3px solid #fff;
  border-radius:50%;
  box-shadow:0 0 0 0 rgba(233,69,96,0.5);
  animation:pulse-ring 1.5s infinite;
}
@keyframes pulse-ring {
  0%   { box-shadow:0 0 0 0 rgba(233,69,96,0.5); }
  70%  { box-shadow:0 0 0 10px rgba(233,69,96,0); }
  100% { box-shadow:0 0 0 0 rgba(233,69,96,0); }
}

/* Other players dot */
.other-dot {
  width:12px; height:12px;
  border:2px solid #fff;
  border-radius:50%;
}

/* Loading */
#loading {
  position:fixed; inset:0; background:#0f1428;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  z-index:9999; color:#fff;
}
.spin {
  width:36px; height:36px;
  border:3px solid #1a2a4a;
  border-top-color:#e94560;
  border-radius:50%;
  animation:spin 0.7s linear infinite;
  margin-bottom:12px;
}
@keyframes spin { to { transform:rotate(360deg); } }
#loading p { font-size:14px; color:#aaa; }
</style>
</head>
<body>

<div id="loading">
  <div class="spin"></div>
  <p>Xarita yuklanmoqda...</p>
</div>

<div id="map"></div>

<!-- TOP -->
<div id="topbar">
  <div id="topbar-left">
    <div id="topbar-title">ğŸ—º Territory Tashkent</div>
    <div id="topbar-sub" id="team-label">Yuklanmoqda...</div>
  </div>
  <div id="topbar-right">
    <div class="stat-pill">ğŸ—º <span id="s-zones">0</span></div>
    <div class="stat-pill">ğŸƒ <span id="s-km">0</span>km</div>
  </div>
</div>

<!-- LEGEND -->
<div id="legend">
  <div><span class="ldot" style="background:#e74c3c"></span>ğŸ”´ Qizil</div>
  <div><span class="ldot" style="background:#3498db"></span>ğŸ”µ Ko'k</div>
  <div><span class="ldot" style="background:#2ecc71"></span>ğŸŸ¢ Yashil</div>
  <div><span class="ldot" style="background:#f39c12"></span>ğŸŸ¡ Sariq</div>
  <div><span class="ldot" style="background:#888"></span>â¬œ Neytral</div>
</div>

<!-- PLAYERS -->
<div id="players-panel">
  <h4>ğŸ‘¥ Faol o'yinchilar</h4>
  <div id="players-list"></div>
</div>

<!-- BOTTOM -->
<div id="bottombar">
  <button class="btn btn-dark" onclick="centerMe()">ğŸ“ Men</button>
  <button class="btn btn-dark" id="btn-players" onclick="togglePlayers()">ğŸ‘¥ O'yinchilar</button>
  <button class="btn btn-dark" id="btn-mine" onclick="toggleMine()">ğŸ´ Menikilar</button>
  <button class="btn btn-red" onclick="refresh()">ğŸ”„</button>
</div>

<!-- ZONE INFO -->
<div id="zone-info">
  <button id="zone-close" onclick="closeZoneInfo()">âœ•</button>
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
    <div id="zi-photo" style="width:44px;height:44px;border-radius:50%;overflow:hidden;flex-shrink:0;border:2px solid #e94560;"></div>
    <div>
      <h3 id="zi-title" style="margin:0"></h3>
      <p id="zi-owner" style="margin:2px 0;font-size:12px;color:#bbb;"></p>
    </div>
  </div>
  <p id="zi-team"></p>
  <p id="zi-area"></p>
  <p id="zi-date"></p>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = "https://myterritorytashbot-production.up.railway.app";
const REFRESH_MS = 15000; // 15 soniyada yangilash

const COLORS = {
  red:     { fill:"#e74c3c", line:"#c0392b" },
  blue:    { fill:"#3498db", line:"#2980b9" },
  green:   { fill:"#2ecc71", line:"#27ae60" },
  yellow:  { fill:"#f39c12", line:"#d68910" },
  neutral: { fill:"#888",    line:"#666" },
};

// Telegram
const tg = window.Telegram?.WebApp;
tg?.ready(); tg?.expand();
const ME = tg?.initDataUnsafe?.user?.id || null;

// Map
const map = L.map("map", { center:[41.3111,69.2799], zoom:13, zoomControl:false });
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom:19, attribution:"Â© OSM"
}).addTo(map);
L.control.zoom({ position:"topright" }).addTo(map);

// Layers
const zonesLayer   = L.layerGroup().addTo(map);
const treksLayer   = L.layerGroup().addTo(map);
const playersLayer = L.layerGroup().addTo(map);

// State
let myMarker = null;
let myLat = null, myLng = null;
let showMine = false;
let showPlayers = true;
let allZones = [];
let allTreks = [];
let allPlayers = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MY LIVE LOCATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.watchPosition(pos => {
    myLat = pos.coords.latitude;
    myLng = pos.coords.longitude;
    const icon = L.divIcon({
      className:"", iconSize:[14,14], iconAnchor:[7,7],
      html:`<div class="my-dot"></div>`
    });
    if (myMarker) {
      myMarker.setLatLng([myLat, myLng]);
    } else {
      myMarker = L.marker([myLat,myLng],{icon,zIndexOffset:1000})
        .addTo(map).bindPopup("ğŸ“ Siz");
      map.setView([myLat,myLng], 15);
    }
  }, null, { enableHighAccuracy:true, maximumAge:3000 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadZones() {
  try {
    const r = await fetch(`${API}/api/zones`);
    allZones = await r.json();
  } catch(e) { console.error("zones:",e); }
}

async function loadTreks() {
  try {
    const r = await fetch(`${API}/api/active_treks`);
    if (r.ok) allTreks = await r.json();
  } catch(e) {}
}

async function loadPlayers() {
  try {
    const r = await fetch(`${API}/api/active_players`);
    if (r.ok) allPlayers = await r.json();
  } catch(e) {}
}

async function loadUserInfo() {
  if (!ME) return;
  try {
    const r = await fetch(`${API}/api/user?user_id=${ME}`);
    if (!r.ok) return;
    const u = await r.json();
    document.getElementById("topbar-sub").textContent =
      `${u.team_emoji||"â“"} ${u.team_name||"Jamoa yo'q"}`;
    document.getElementById("s-zones").textContent = u.zones_owned||0;
    document.getElementById("s-km").textContent = (u.total_km||0).toFixed(1);
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ZONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderZones() {
  zonesLayer.clearLayers();
  const list = showMine
    ? allZones.filter(z => String(z.owner_id) === String(ME))
    : allZones;

  list.forEach(zone => {
    const c = COLORS[zone.team] || COLORS.neutral;
    const style = { color:c.line, fillColor:c.fill, fillOpacity:0.3, weight:2 };
    let layer;

    if (zone.type === "circle") {
      layer = L.circle([zone.center_lat, zone.center_lng],
        { radius: zone.radius_m||50, ...style });
    } else {
      const geom = Array.isArray(zone.geometry) ? zone.geometry : [];
      if (geom.length >= 3) {
        layer = L.polygon(geom.map(p=>[p.lat,p.lng]), style);
      }
    }

    if (!layer) return;
    layer.on("click", () => showZoneInfo(zone));
    layer.addTo(zonesLayer);

    // Zona markaziga egasining rasmi yoki nomi
    const iconSize = zone.type === "circle"
      ? Math.max(24, Math.min(zone.radius_m||50, 50)) * 0.6
      : 32;

    let iconHtml;
    if (zone.photo_url) {
      iconHtml = `<div style="
        width:${iconSize}px; height:${iconSize}px;
        border-radius:50%;
        border:2px solid ${c.line};
        overflow:hidden;
        box-shadow:0 0 6px ${c.fill}88;
        pointer-events:none;
      ">
        <img src="${zone.photo_url}"
          style="width:100%;height:100%;object-fit:cover;"
          onerror="this.parentElement.innerHTML='<div style=\'width:100%;height:100%;background:${c.fill};display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;\'>${zone.team_emoji||"?"}</div>'"
        />
      </div>`;
    } else {
      iconHtml = `<div style="
        background:${c.fill};
        color:#fff;
        width:${iconSize}px; height:${iconSize}px;
        border-radius:50%;
        border:2px solid ${c.line};
        display:flex; align-items:center; justify-content:center;
        font-size:${iconSize*0.45}px;
        box-shadow:0 0 6px ${c.fill}88;
        pointer-events:none;
      ">${zone.team_emoji||"?"}</div>`;
    }

    L.marker([zone.center_lat, zone.center_lng], {
      icon: L.divIcon({
        className:"",
        html: iconHtml,
        iconSize:[iconSize, iconSize],
        iconAnchor:[iconSize/2, iconSize/2],
      }),
      zIndexOffset: 100,
    }).on("click", () => showZoneInfo(zone)).addTo(zonesLayer);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TREKS (yurgan yo'llar)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTreks() {
  treksLayer.clearLayers();
  allTreks.forEach(trek => {
    if (!trek.points || trek.points.length < 2) return;
    const c = COLORS[trek.team] || COLORS.neutral;
    const latlngs = trek.points.map(p => [p.lat, p.lng]);

    // Yo'l chizig'i
    L.polyline(latlngs, {
      color: c.fill,
      weight: 3,
      opacity: 0.85,
      dashArray: "6,4",
    }).addTo(treksLayer);

    // Boshlang'ich nuqta
    L.circleMarker(latlngs[0], {
      radius:5, color:c.line, fillColor:c.fill, fillOpacity:1, weight:2
    }).addTo(treksLayer);

    // Oxirgi nuqta (harakat)
    const last = latlngs[latlngs.length-1];
    L.circleMarker(last, {
      radius:6, color:"#fff", fillColor:c.fill, fillOpacity:1, weight:2
    }).bindPopup(`${c.fill} ${trek.owner_name||"?"} yurmoqda`)
      .addTo(treksLayer);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayers() {
  playersLayer.clearLayers();
  document.getElementById("players-list").innerHTML = "";

  allPlayers.forEach(p => {
    if (String(p.user_id) === String(ME)) return;
    if (!p.lat || !p.lng) return;

    const c = COLORS[p.team] || COLORS.neutral;
    const icon = L.divIcon({
      className:"",
      iconSize:[12,12], iconAnchor:[6,6],
      html:`<div class="other-dot" style="background:${c.fill}"></div>`
    });
    L.marker([p.lat,p.lng],{icon})
      .bindPopup(`${c.fill.includes("e74")?"ğŸ”´":c.fill.includes("3498")?"ğŸ”µ":c.fill.includes("2ecc")?"ğŸŸ¢":"ğŸŸ¡"} ${p.name||"O'yinchi"}`)
      .addTo(playersLayer);

    // Players panel
    const row = document.createElement("div");
    row.className = "player-row";
    row.textContent = `${p.team_emoji||"â“"} ${p.name||"?"}`;
    document.getElementById("players-list").appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE INFO POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showZoneInfo(zone) {
  const c = COLORS[zone.team] || COLORS.neutral;
  document.getElementById("zi-title").textContent =
    `${zone.team_emoji||""} Zona #${zone.id}`;
  document.getElementById("zi-owner").textContent = `ğŸ‘¤ ${zone.owner_name||"Neytral"}`;
  document.getElementById("zi-team").textContent  = `ğŸ½ ${zone.team_name||""}`;
  const a = zone.area_m2||0;
  document.getElementById("zi-area").textContent  =
    `ğŸ“ ${a<10000 ? a.toFixed(0)+"mÂ²" : (a/10000).toFixed(2)+"ga"}`;
  document.getElementById("zi-date").textContent  =
    `ğŸ“… ${(zone.created_at||"").substring(0,10)}`;

  // Rasm
  const photoDiv = document.getElementById("zi-photo");
  photoDiv.style.borderColor = c.line;
  if (zone.photo_url) {
    photoDiv.innerHTML = `<img src="${zone.photo_url}"
      style="width:100%;height:100%;object-fit:cover;"
      onerror="this.parentElement.innerHTML='<div style=\'width:100%;height:100%;background:${c.fill};display:flex;align-items:center;justify-content:center;font-size:20px;\'>${zone.team_emoji||"?"}</div>'"
    />`;
  } else {
    photoDiv.innerHTML = `<div style="width:100%;height:100%;background:${c.fill};display:flex;align-items:center;justify-content:center;font-size:22px;">${zone.team_emoji||"?"}</div>`;
  }

  document.getElementById("zone-info").style.display = "block";
}

function closeZoneInfo() {
  document.getElementById("zone-info").style.display = "none";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function centerMe() {
  if (myLat && myLng) map.setView([myLat,myLng], 16);
  else tg?.showAlert("ğŸ“ Joylashuvingiz aniqlanmagan");
}

function toggleMine() {
  showMine = !showMine;
  const btn = document.getElementById("btn-mine");
  btn.textContent = showMine ? "ğŸŒ Hammasi" : "ğŸ´ Menikilar";
  btn.className = showMine ? "btn btn-active" : "btn btn-dark";
  renderZones();
}

function togglePlayers() {
  showPlayers = !showPlayers;
  const btn = document.getElementById("btn-players");
  btn.textContent = showPlayers ? "ğŸ‘ Yashir" : "ğŸ‘¥ O'yinchilar";
  btn.className = showPlayers ? "btn btn-active" : "btn btn-dark";
  document.getElementById("players-panel").style.display =
    showPlayers ? "block" : "none";
  if (showPlayers) renderPlayers();
  else playersLayer.clearLayers();
}

async function refresh() {
  await Promise.all([loadZones(), loadTreks(), loadPlayers()]);
  renderZones();
  renderTreks();
  renderPlayers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  startLocation();
  await Promise.all([loadZones(), loadTreks(), loadPlayers(), loadUserInfo()]);
  renderZones();
  renderTreks();
  renderPlayers();
  document.getElementById("loading").style.display = "none";

  // Auto refresh
  setInterval(async () => {
    await Promise.all([loadZones(), loadTreks(), loadPlayers()]);
    renderZones();
    renderTreks();
    renderPlayers();
  }, REFRESH_MS);
}

init();
</script>
</body>
</html>
