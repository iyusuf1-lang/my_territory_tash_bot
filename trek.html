<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Myterritoriy - Trek</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: #0f0f11; color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .header { text-align: center; margin-bottom: 30px; }
        .flag-icon { font-size: 50px; }
        h1 { font-size: 24px; font-weight: bold; margin: 10px 0; }
        
        .card { background-color: #1a1b1f; border-radius: 12px; width: 100%; max-width: 400px; padding: 20px; margin-bottom: 20px; border: 1px solid #2a2b30; }
        .row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #2a2b30; font-size: 16px; }
        .row:last-child { border-bottom: none; }
        .label { color: #8e8e93; }
        .value { font-weight: bold; font-family: monospace; }
        
        .btn-submit { background-color: #e53935; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; width: 100%; max-width: 400px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-submit:active { opacity: 0.8; }
        .loading { display: none; }
        .team-color { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="flag-icon">üèÅ</div>
        <h1 id="status-title">Trek yozilmoqda...</h1>
    </div>

    <div class="card">
        <div class="row">
            <span class="label">Masofa</span>
            <span class="value" id="val-distance">0.000 km</span>
        </div>
        <div class="row">
            <span class="label">Nuqtalar</span>
            <span class="value" id="val-points">0</span>
        </div>
        <div class="row">
            <span class="label">Jamoa</span>
            <span class="value" style="text-transform: uppercase;">
                <span id="team-circle" class="team-color" style="background: gray;"></span>
                <span id="val-team">Noma'lum</span>
            </span>
        </div>
        <div class="row">
            <span class="label">Zona holati</span>
            <span class="value" id="val-status" style="color: #ff9800;">Ochiq</span>
        </div>
    </div>

    <button id="btn-finish" class="btn-submit" onclick="submitTrek()">
        <span class="loading" id="spinner">‚è≥</span>
        <span id="btn-text">Yakunlash va Yuborish</span>
    </button>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // URL dan jamoani olish (Masalan: ?team=yellow)
    const urlParams = new URLSearchParams(window.location.search);
    let userTeam = urlParams.get('team') || 'nomalum';
    
    // Jamoa rangini belgilash
    const teamColors = { "red": "#e53935", "blue": "#1e88e5", "green": "#43a047", "yellow": "#fdd835" };
    document.getElementById('val-team').innerText = userTeam;
    document.getElementById('team-circle').style.background = teamColors[userTeam] || 'gray';

    let points = [];
    let distanceMeters = 0;
    let isClosed = false;

    // Masofa hisoblash (Haversine formula)
    function calcDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const p1 = lat1 * Math.PI/180;
        const p2 = lat2 * Math.PI/180;
        const dp = (lat2-lat1) * Math.PI/180;
        const dl = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // GPS kuzatish
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                if (points.length > 0) {
                    const last = points[points.length - 1];
                    distanceMeters += calcDistance(last.lat, last.lng, lat, lng);
                }
                
                points.push({ lat, lng });
                document.getElementById('val-points').innerText = points.length;
                document.getElementById('val-distance').innerText = (distanceMeters / 1000).toFixed(3) + ' km';

                // Yopiqlikni tekshirish (kamida 10 nuqta va boshlang'ichga 50m qolganda)
                if (points.length > 10) {
                    const distToStart = calcDistance(points[0].lat, points[0].lng, lat, lng);
                    if (distToStart < 50) {
                        isClosed = true;
                        document.getElementById('val-status').innerText = '‚úÖ Yopiq';
                        document.getElementById('val-status').style.color = '#4caf50';
                    }
                }
            },
            (err) => console.error(err),
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }

    // Serverga yuborish (XAVFSIZLIK QO'SHILGAN QISM)
    async function submitTrek() {
        if (points.length < 5) {
            tg.showAlert("Trek juda qisqa! Kamida 5 nuqta kerak.");
            return;
        }

        const btn = document.getElementById('btn-finish');
        btn.style.opacity = '0.5';
        btn.disabled = true;
        document.getElementById('spinner').style.display = 'inline-block';
        document.getElementById('btn-text').innerText = 'Yuborilmoqda...';

        // O'zingizning API linkizni qo'ying, masalan: https://my-bot.uz/api/trek_submit
        const API_URL = "https://iyusuf1-lang.github.io/api/trek_submit"; // DIQQAT: O'ZINGIZNING HOSTINGIZ URL INI YOZING

        const payload = {
            points: points,
            distance: distanceMeters,
            team: userTeam,
            closed: isClosed,
            init_data: tg.initData  // <----- MANA SHU NING UCHUN XATO BERGANDI, ENDI ISHLAYDI
        };

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (response.ok && result.ok) {
                document.getElementById('status-title').innerText = "‚úÖ Zona yaratildi!";
                document.getElementById('status-title').style.color = "#4caf50";
                btn.style.display = 'none';
                tg.HapticFeedback.notificationOccurred("success");
                
                // 2 soniyadan keyin miniapp yopiladi
                setTimeout(() => { tg.close(); }, 2000);
            } else {
                throw new Error(result.error || "Noma'lum xatolik");
            }
        } catch (error) {
            btn.style.opacity = '1';
            btn.disabled = false;
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('btn-text').innerText = 'Qayta yuborish';
            
            // Xato ekranida chiqariladi
            tg.showAlert("‚ùå Xato: " + error.message);
            tg.HapticFeedback.notificationOccurred("error");
        }
    }
</script>
</body>
</html>
