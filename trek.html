<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Territory Trek</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root {
    --red:    #FF3B3B;
    --blue:   #2979FF;
    --green:  #00E676;
    --yellow: #FFD600;
    --bg:     #0a0a0f;
    --surface:#13131a;
    --border: rgba(255,255,255,0.08);
    --text:   #f0f0f8;
    --muted:  rgba(240,240,248,0.45);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ MAP â”€â”€ */
  #map {
    flex: 1;
    position: relative;
    z-index: 1;
  }

  /* Dark map tiles overlay */
  #map::after {
    content:'';
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(10,10,15,0.15) 0%, transparent 30%);
    pointer-events:none;
    z-index:500;
  }

  /* â”€â”€ TEAM SELECTOR â”€â”€ */
  #team-screen {
    position: absolute; inset:0;
    background: var(--bg);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 24px;
    padding: 32px;
  }

  .team-title {
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.2em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .team-heading {
    font-size: 32px;
    font-weight: 900;
    letter-spacing: -0.02em;
    text-align: center;
    line-height: 1.1;
  }

  .team-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    width: 100%;
    max-width: 340px;
  }

  .team-btn {
    padding: 20px 16px;
    border-radius: 16px;
    border: 2px solid transparent;
    background: var(--surface);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .team-btn:active { transform: scale(0.95); }
  .team-btn.selected { border-color: var(--team-color); box-shadow: 0 0 20px var(--team-color-30); }

  .team-btn .emoji { font-size: 28px; }
  .team-btn .label {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .team-btn[data-team="red"]    { --team-color: var(--red);    --team-color-30: rgba(255,59,59,0.3); }
  .team-btn[data-team="blue"]   { --team-color: var(--blue);   --team-color-30: rgba(41,121,255,0.3); }
  .team-btn[data-team="green"]  { --team-color: var(--green);  --team-color-30: rgba(0,230,118,0.3); }
  .team-btn[data-team="yellow"] { --team-color: var(--yellow); --team-color-30: rgba(255,214,0,0.3); }

  .start-btn {
    width: 100%;
    max-width: 340px;
    padding: 18px;
    border-radius: 16px;
    border: none;
    background: white;
    color: #0a0a0f;
    font-family: 'Outfit', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    opacity: 0.4;
    pointer-events: none;
  }

  .start-btn.active {
    opacity: 1;
    pointer-events: auto;
    background: var(--team-active-color, white);
    color: #0a0a0f;
  }

  .start-btn:active { transform: scale(0.97); }

  /* â”€â”€ HUD OVERLAY â”€â”€ */
  #hud {
    position: absolute;
    top: 0; left: 0; right: 0;
    z-index: 600;
    pointer-events: none;
  }

  /* Top stats bar */
  .stats-bar {
    margin: 12px;
    background: rgba(10,10,15,0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 16px;
    border: 1px solid var(--border);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    pointer-events: auto;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .stat-value {
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    line-height: 1;
  }

  .stat-label {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .stat-divider {
    width: 1px;
    height: 32px;
    background: var(--border);
  }

  /* Team badge */
  .team-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  /* GPS status */
  .gps-status {
    margin: 0 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: rgba(10,10,15,0.75);
    backdrop-filter: blur(8px);
    border-radius: 20px;
    border: 1px solid var(--border);
    font-size: 12px;
    color: var(--muted);
    pointer-events: none;
  }

  .gps-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #666;
    flex-shrink: 0;
  }

  .gps-dot.searching { background: #FFD600; animation: pulse-dot 1s infinite; }
  .gps-dot.active    { background: #00E676; animation: pulse-dot 2s infinite; }
  .gps-dot.error     { background: #FF3B3B; }

  @keyframes pulse-dot {
    0%, 100% { opacity:1; transform:scale(1); }
    50%       { opacity:0.5; transform:scale(0.7); }
  }

  /* â”€â”€ BOTTOM PANEL â”€â”€ */
  #bottom-panel {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    z-index: 600;
    padding: 0 12px 20px;
    pointer-events: none;
  }

  /* Closed zone alert */
  .zone-alert {
    margin-bottom: 10px;
    padding: 12px 16px;
    background: rgba(0,230,118,0.15);
    border: 1px solid rgba(0,230,118,0.4);
    border-radius: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 600;
    color: #00E676;
    display: none;
  }

  .zone-alert.show { display: flex; }

  /* Action buttons */
  .action-row {
    display: flex;
    gap: 10px;
    pointer-events: auto;
  }

  .btn-recenter {
    width: 52px; height: 52px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(10,10,15,0.85);
    backdrop-filter: blur(12px);
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
  }

  .btn-recenter:active { transform: scale(0.92); background: var(--surface); }

  .btn-finish {
    flex: 1;
    height: 52px;
    border-radius: 14px;
    border: none;
    background: #FF3B3B;
    color: white;
    font-family: 'Outfit', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.02em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.15s;
    box-shadow: 0 4px 20px rgba(255,59,59,0.35);
  }

  .btn-finish:active { transform: scale(0.97); }
  .btn-finish:disabled { opacity: 0.5; box-shadow: none; cursor: not-allowed; }

  /* â”€â”€ LOADING â”€â”€ */
  #loading {
    position: absolute; inset:0;
    background: var(--bg);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    transition: opacity 0.4s;
  }

  #loading.hide { opacity: 0; pointer-events: none; }

  .loading-ring {
    width: 48px; height: 48px;
    border: 3px solid var(--border);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-size: 14px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.1em;
  }

  /* â”€â”€ RESULT SCREEN â”€â”€ */
  #result-screen {
    position: absolute; inset:0;
    background: var(--bg);
    z-index: 1500;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px;
    gap: 20px;
  }

  #result-screen.show { display: flex; }

  .result-icon { font-size: 64px; }

  .result-title {
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -0.02em;
    text-align: center;
  }

  .result-stats {
    width: 100%;
    max-width: 320px;
    background: var(--surface);
    border-radius: 16px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .result-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
  }

  .result-row:last-child { border-bottom: none; }

  .result-key {
    font-size: 13px;
    color: var(--muted);
  }

  .result-val {
    font-family: 'Space Mono', monospace;
    font-size: 15px;
    font-weight: 700;
  }

  .btn-send {
    width: 100%;
    max-width: 320px;
    padding: 18px;
    border-radius: 16px;
    border: none;
    background: #00E676;
    color: #0a0a0f;
    font-family: 'Outfit', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-send:active { transform: scale(0.97); }

  /* Leaflet custom styles */
  .leaflet-control-zoom { display: none !important; }
  .leaflet-control-attribution { font-size: 8px !important; opacity: 0.4 !important; }

  .current-location-marker {
    width: 18px; height: 18px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 4px rgba(255,255,255,0.2), 0 2px 8px rgba(0,0,0,0.5);
  }

  .start-marker {
    width: 14px; height: 14px;
    border-radius: 50%;
    border: 3px solid white;
    background: #00E676;
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="loading-ring"></div>
  <div class="loading-text">YUKLANMOQDA...</div>
</div>

<!-- TEAM SELECTOR -->
<div id="team-screen">
  <div>
    <div class="team-title">Territory Trek</div>
    <div class="team-heading">Jamoangizni<br>tanlang</div>
  </div>

  <div class="team-grid">
    <button class="team-btn" data-team="red" onclick="selectTeam('red', '#FF3B3B')">
      <span class="emoji">ğŸ”´</span>
      <span class="label">QIZIL</span>
    </button>
    <button class="team-btn" data-team="blue" onclick="selectTeam('blue', '#2979FF')">
      <span class="emoji">ğŸ”µ</span>
      <span class="label">KO'K</span>
    </button>
    <button class="team-btn" data-team="green" onclick="selectTeam('green', '#00E676')">
      <span class="emoji">ğŸŸ¢</span>
      <span class="label">YASHIL</span>
    </button>
    <button class="team-btn" data-team="yellow" onclick="selectTeam('yellow', '#FFD600')">
      <span class="emoji">ğŸŸ¡</span>
      <span class="label">SARIQ</span>
    </button>
  </div>

  <button class="start-btn" id="start-trek-btn" onclick="startTrek()">
    <span>â–¶</span> TREKNI BOSHLASH
  </button>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- HUD -->
<div id="hud" style="display:none">
  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="stat-dist">0.000</div>
      <div class="stat-label">KM</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-value" id="stat-pts">0</div>
      <div class="stat-label">NUQTA</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-value" id="stat-time">00:00</div>
      <div class="stat-label">VAQT</div>
    </div>
    <div class="stat-divider"></div>
    <div class="team-badge" id="team-badge">
      <span id="team-emoji">ğŸ”´</span>
      <span id="team-name">QIZIL</span>
    </div>
  </div>

  <div class="gps-status">
    <div class="gps-dot searching" id="gps-dot"></div>
    <span id="gps-text">GPS aniqlanmoqda...</span>
  </div>
</div>

<!-- BOTTOM PANEL -->
<div id="bottom-panel" style="display:none">
  <div class="zone-alert" id="zone-alert">
    âœ… Aylana yopildi! Trek tugatish mumkin
  </div>
  <div class="action-row">
    <button class="btn-recenter" onclick="recenter()">ğŸ“</button>
    <button class="btn-finish" id="finish-btn" onclick="finishTrek()">
      â¹ Trek Tugatish
    </button>
  </div>
</div>

<!-- RESULT -->
<div id="result-screen">
  <div class="result-icon" id="result-icon">âœ…</div>
  <div class="result-title" id="result-title">Trek yakunlandi!</div>
  <div class="result-stats" id="result-stats"></div>
  <button class="btn-send" id="result-btn" onclick="sendResult()">
    ğŸ´ Zona yaratish
  </button>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM WEB APP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
  tg.setHeaderColor('#0a0a0f');
  tg.setBackgroundColor('#0a0a0f');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TEAM_COLORS = {
  red:    { color: '#FF3B3B', emoji: 'ğŸ”´', name: 'QIZIL'  },
  blue:   { color: '#2979FF', emoji: 'ğŸ”µ', name: "KO'K"   },
  green:  { color: '#00E676', emoji: 'ğŸŸ¢', name: 'YASHIL' },
  yellow: { color: '#FFD600', emoji: 'ğŸŸ¡', name: 'SARIQ'  },
};

let state = {
  team: null,
  teamColor: null,
  points: [],
  tracking: false,
  watchId: null,
  startTime: null,
  timerInterval: null,
  isClosed: false,
  map: null,
  polyline: null,
  closingLine: null,
  currentMarker: null,
  startMarker: null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap() {
  state.map = L.map('map', {
    zoomControl: false,
    attributionControl: true,
  }).setView([41.2995, 69.2401], 16);

  // Dark map tiles
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© CartoDB',
    maxZoom: 19,
  }).addTo(state.map);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTeam(team, color) {
  state.team = team;
  state.teamColor = TEAM_COLORS[team].color;

  document.querySelectorAll('.team-btn').forEach(b => {
    b.classList.remove('selected');
    b.style.removeProperty('--team-active-color');
  });

  const btn = document.querySelector(`[data-team="${team}"]`);
  btn.classList.add('selected');
  btn.style.setProperty('--team-color', color);

  const startBtn = document.getElementById('start-trek-btn');
  startBtn.classList.add('active');
  startBtn.style.background = color;
  startBtn.style.setProperty('--team-active-color', color);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START TREK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTrek() {
  if (!state.team) return;

  // Hide team screen
  document.getElementById('team-screen').style.display = 'none';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('bottom-panel').style.display = 'block';

  // Update team badge
  const t = TEAM_COLORS[state.team];
  document.getElementById('team-emoji').textContent = t.emoji;
  document.getElementById('team-name').textContent = t.name;
  document.getElementById('team-badge').style.background = state.teamColor + '22';
  document.getElementById('team-badge').style.color = state.teamColor;

  state.tracking = true;
  state.startTime = Date.now();

  // Start timer
  state.timerInterval = setInterval(updateTimer, 1000);

  // Init polyline
  state.polyline = L.polyline([], {
    color: state.teamColor,
    weight: 4,
    opacity: 0.9,
    lineJoin: 'round',
    lineCap: 'round',
  }).addTo(state.map);

  // Start GPS
  startGPS();

  // Hide loading
  document.getElementById('loading').classList.add('hide');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGPS() {
  if (!navigator.geolocation) {
    setGpsStatus('error', 'âŒ GPS mavjud emas');
    return;
  }

  setGpsStatus('searching', 'GPS aniqlanmoqda...');

  const options = {
    enableHighAccuracy: true,
    timeout: 15000,
    maximumAge: 0,
  };

  state.watchId = navigator.geolocation.watchPosition(
    onGpsSuccess,
    onGpsError,
    options
  );
}

function onGpsSuccess(pos) {
  const { latitude: lat, longitude: lng, accuracy } = pos.coords;

  setGpsStatus('active', `Â±${Math.round(accuracy)}m aniqlik`);

  // First point
  if (state.points.length === 0) {
    state.map.setView([lat, lng], 17);

    // Start marker
    const startIcon = L.divIcon({
      className: '',
      html: '<div class="start-marker"></div>',
      iconSize: [14, 14],
      iconAnchor: [7, 7],
    });
    state.startMarker = L.marker([lat, lng], { icon: startIcon }).addTo(state.map);
  }

  // Min distance filter (8m)
  if (state.points.length > 0) {
    const last = state.points[state.points.length - 1];
    const d = haversine(last.lat, last.lng, lat, lng);
    if (d < 8) return;
  }

  // Add point
  state.points.push({ lat, lng, time: new Date().toISOString() });

  // Update polyline
  const latlngs = state.points.map(p => [p.lat, p.lng]);
  state.polyline.setLatLngs(latlngs);

  // Closing line (dashed)
  if (state.points.length >= 3) {
    const first = state.points[0];
    const last  = state.points[state.points.length - 1];

    if (state.closingLine) {
      state.closingLine.remove();
    }
    state.closingLine = L.polyline(
      [[last.lat, last.lng], [first.lat, first.lng]],
      { color: state.teamColor, weight: 2, opacity: 0.35, dashArray: '6,8' }
    ).addTo(state.map);
  }

  // Update current position marker
  updateCurrentMarker(lat, lng);

  // Update stats
  updateStats();

  // Check closed
  checkClosed();
}

function onGpsError(err) {
  const msgs = {
    1: 'GPS ruxsat berilmadi âŒ',
    2: 'GPS signali yo\'q ğŸ“¡',
    3: 'GPS vaqt tugadi â±',
  };
  setGpsStatus('error', msgs[err.code] || 'GPS xato');
}

function updateCurrentMarker(lat, lng) {
  const icon = L.divIcon({
    className: '',
    html: `<div class="current-location-marker" style="background:${state.teamColor}"></div>`,
    iconSize: [18, 18],
    iconAnchor: [9, 9],
  });

  if (state.currentMarker) {
    state.currentMarker.setLatLng([lat, lng]);
  } else {
    state.currentMarker = L.marker([lat, lng], { icon }).addTo(state.map);
  }
}

function recenter() {
  if (state.points.length > 0) {
    const last = state.points[state.points.length - 1];
    state.map.setView([last.lat, last.lng], 17, { animate: true });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHECK CLOSED (50m threshold)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkClosed() {
  if (state.points.length < 8) return;
  const first = state.points[0];
  const last  = state.points[state.points.length - 1];
  const d = haversine(first.lat, first.lng, last.lat, last.lng);

  if (d <= 50 && !state.isClosed) {
    state.isClosed = true;
    document.getElementById('zone-alert').classList.add('show');

    // Highlight polyline
    state.polyline.setStyle({ weight: 5, opacity: 1 });

    // Fill polygon preview
    if (state.closingLine) state.closingLine.remove();
    L.polygon(
      state.points.map(p => [p.lat, p.lng]),
      { color: state.teamColor, fillColor: state.teamColor, fillOpacity: 0.18, weight: 3 }
    ).addTo(state.map);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS & TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const dist = calcDistance();
  document.getElementById('stat-dist').textContent = (dist / 1000).toFixed(3);
  document.getElementById('stat-pts').textContent = state.points.length;
}

function updateTimer() {
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
  const s = (elapsed % 60).toString().padStart(2, '0');
  document.getElementById('stat-time').textContent = `${m}:${s}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINISH TREK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function finishTrek() {
  if (state.points.length < 5) {
    alert('Trek juda qisqa! Kamida biroz yuring.');
    return;
  }

  // Stop GPS & timer
  if (state.watchId !== null) {
    navigator.geolocation.clearWatch(state.watchId);
    state.watchId = null;
  }
  clearInterval(state.timerInterval);
  state.tracking = false;

  const dist = calcDistance();
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
  const s = (elapsed % 60).toString().padStart(2, '0');

  // Show result
  const t = TEAM_COLORS[state.team];
  document.getElementById('result-icon').textContent = state.isClosed ? 'ğŸ´' : 'âš ï¸';
  document.getElementById('result-title').textContent = state.isClosed
    ? 'Zona yaratildi!'
    : 'Trek yakunlandi';

  const distStr = (dist / 1000).toFixed(3);
  const closeD = state.points.length > 1
    ? Math.round(haversine(state.points[0].lat, state.points[0].lng,
        state.points[state.points.length-1].lat, state.points[state.points.length-1].lng))
    : 'â€”';

  document.getElementById('result-stats').innerHTML = `
    <div class="result-row">
      <span class="result-key">Masofa</span>
      <span class="result-val">${distStr} km</span>
    </div>
    <div class="result-row">
      <span class="result-key">Nuqtalar</span>
      <span class="result-val">${state.points.length}</span>
    </div>
    <div class="result-row">
      <span class="result-key">Vaqt</span>
      <span class="result-val">${m}:${s}</span>
    </div>
    <div class="result-row">
      <span class="result-key">Jamoa</span>
      <span class="result-val" style="color:${t.color}">${t.emoji} ${t.name}</span>
    </div>
    <div class="result-row">
      <span class="result-key">Zona holati</span>
      <span class="result-val" style="color:${state.isClosed ? '#00E676' : '#FF3B3B'}">
        ${state.isClosed ? 'âœ… Yopiq' : `âš ï¸ ${closeD}m qoldi`}
      </span>
    </div>
  `;

  const sendBtn = document.getElementById('result-btn');
  if (state.isClosed) {
    sendBtn.textContent = 'ğŸ´ Zona yaratish';
    sendBtn.style.background = '#00E676';
  } else {
    sendBtn.textContent = 'ğŸ“¤ Trek saqlash (zona yaratilmaydi)';
    sendBtn.style.background = '#555';
    sendBtn.style.color = 'white';
  }

  document.getElementById('result-screen').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEND TO BOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendResult() {
  const dist = calcDistance();
  const payload = {
    action:   'trek_finished',
    team:     state.team,
    points:   state.points,
    distance: dist,
    closed:   state.isClosed,
  };

  if (tg) {
    tg.sendData(JSON.stringify(payload));
  } else {
    // Dev mode
    console.log('Trek data:', payload);
    alert('Trek yuborildi! (dev mode)');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2
    + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

function calcDistance() {
  let total = 0;
  for (let i = 1; i < state.points.length; i++) {
    total += haversine(
      state.points[i-1].lat, state.points[i-1].lng,
      state.points[i].lat, state.points[i].lng
    );
  }
  return total;
}

function setGpsStatus(status, text) {
  const dot = document.getElementById('gps-dot');
  dot.className = 'gps-dot ' + status;
  document.getElementById('gps-text').textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  initMap();

  // Check if team passed via URL param (from bot)
  const params = new URLSearchParams(window.location.search);
  const preTeam = params.get('team');
  if (preTeam && TEAM_COLORS[preTeam]) {
    selectTeam(preTeam, TEAM_COLORS[preTeam].color);
  }

  // Check if user already in trek (bot sent team via tg.initData)
  if (tg?.initDataUnsafe?.start_param) {
    const t = tg.initDataUnsafe.start_param;
    if (TEAM_COLORS[t]) selectTeam(t, TEAM_COLORS[t].color);
  }

  setTimeout(() => {
    document.getElementById('loading').classList.add('hide');
  }, 800);
});
</script>
</body>
</html>
