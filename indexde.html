<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Territory - Xarita</title>

<!-- Leaflet.js xarita -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<!-- Telegram Mini App SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #1a1a2e;
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#header {
  background: linear-gradient(135deg, #16213e, #0f3460);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #e94560;
  flex-shrink: 0;
  z-index: 1000;
}

#header h1 {
  font-size: 16px;
  font-weight: 700;
  color: #e94560;
}

#team-badge {
  font-size: 13px;
  padding: 4px 10px;
  border-radius: 20px;
  background: rgba(255,255,255,0.1);
}

#stats-bar {
  background: #16213e;
  padding: 6px 16px;
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: #aaa;
  border-bottom: 1px solid #0f3460;
  flex-shrink: 0;
}

#stats-bar span { color: #fff; font-weight: 600; }

#map {
  flex: 1;
  width: 100%;
}

#bottom-panel {
  background: #16213e;
  border-top: 1px solid #0f3460;
  padding: 8px 16px;
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary { background: #e94560; color: #fff; }
.btn-secondary { background: #0f3460; color: #fff; }
.btn:active { transform: scale(0.96); }

#zone-popup {
  display: none;
  position: fixed;
  bottom: 70px;
  left: 16px;
  right: 16px;
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 16px;
  padding: 16px;
  z-index: 2000;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
}

#zone-popup h3 { font-size: 15px; margin-bottom: 8px; }
#zone-popup p  { font-size: 13px; color: #aaa; margin: 3px 0; }
#popup-close {
  position: absolute;
  top: 10px; right: 14px;
  background: none; border: none;
  color: #aaa; font-size: 20px; cursor: pointer;
}

#loading {
  position: fixed; inset: 0;
  background: #1a1a2e;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 9999;
}

#loading p { margin-top: 12px; color: #aaa; font-size: 14px; }

.spinner {
  width: 40px; height: 40px;
  border: 3px solid #0f3460;
  border-top-color: #e94560;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Legend */
#legend {
  position: absolute;
  top: 120px; right: 10px;
  background: rgba(22,33,62,0.95);
  border: 1px solid #0f3460;
  border-radius: 10px;
  padding: 10px 14px;
  z-index: 1000;
  font-size: 12px;
}

#legend div { margin: 3px 0; }
#legend .dot {
  display: inline-block;
  width: 10px; height: 10px;
  border-radius: 50%;
  margin-right: 6px;
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <p>Xarita yuklanmoqda...</p>
</div>

<!-- Header -->
<div id="header">
  <h1>üó∫ Territory Tashkent</h1>
  <div id="team-badge">‚ùì Yuklanmoqda</div>
</div>

<!-- Stats -->
<div id="stats-bar">
  <div>üó∫ Zonalar: <span id="stat-zones">-</span></div>
  <div>üèÉ Masofa: <span id="stat-km">-</span> km</div>
  <div>‚öîÔ∏è Egallangan: <span id="stat-captures">-</span></div>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Legend -->
<div id="legend">
  <div><span class="dot" style="background:#e74c3c"></span>üî¥ Qizil</div>
  <div><span class="dot" style="background:#3498db"></span>üîµ Ko'k</div>
  <div><span class="dot" style="background:#2ecc71"></span>üü¢ Yashil</div>
  <div><span class="dot" style="background:#f39c12"></span>üü° Sariq</div>
  <div><span class="dot" style="background:#95a5a6"></span>‚¨ú Neytral</div>
</div>

<!-- Bottom buttons -->
<div id="bottom-panel">
  <button class="btn btn-secondary" onclick="centerOnMe()">üìç Menga</button>
  <button class="btn btn-primary" onclick="loadZones()">üîÑ Yangilash</button>
  <button class="btn btn-secondary" onclick="toggleMyZones()">üè¥ Menikilar</button>
</div>

<!-- Zone popup -->
<div id="zone-popup">
  <button id="popup-close" onclick="closePopup()">‚úï</button>
  <h3 id="popup-title">Zona</h3>
  <p id="popup-owner"></p>
  <p id="popup-team"></p>
  <p id="popup-area"></p>
  <p id="popup-date"></p>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî GitHub Pages dan Railway API ga ulanish
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_BASE = "https://myterritorytashbot-production.up.railway.app";

const TEAM_COLORS = {
  red:     { fill: "#e74c3c", border: "#c0392b" },
  blue:    { fill: "#3498db", border: "#2980b9" },
  green:   { fill: "#2ecc71", border: "#27ae60" },
  yellow:  { fill: "#f39c12", border: "#e67e22" },
  neutral: { fill: "#95a5a6", border: "#7f8c8d" },
};

// Telegram WebApp
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const userId = tg.initDataUnsafe?.user?.id || null;

// Map
const map = L.map("map", {
  center: [41.3111, 69.2799],
  zoom: 13,
  zoomControl: true,
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap",
  maxZoom: 19,
}).addTo(map);

// State
let zonesLayer = L.layerGroup().addTo(map);
let myLocationMarker = null;
let showOnlyMine = false;
let allZones = [];
let currentLat = null, currentLng = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE LOCATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startLiveLocation() {
  if (!navigator.geolocation) return;
  
  navigator.geolocation.watchPosition(
    (pos) => {
      currentLat = pos.coords.latitude;
      currentLng = pos.coords.longitude;
      
      if (myLocationMarker) {
        myLocationMarker.setLatLng([currentLat, currentLng]);
      } else {
        const icon = L.divIcon({
          className: "",
          html: `<div style="
            width:16px; height:16px;
            background:#e94560;
            border:3px solid #fff;
            border-radius:50%;
            box-shadow:0 0 8px #e94560;
            animation: pulse 1.5s infinite;
          "></div>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8],
        });
        myLocationMarker = L.marker([currentLat, currentLng], { icon })
          .addTo(map)
          .bindPopup("üìç Sizning joylashuvingiz");
        map.setView([currentLat, currentLng], 15);
      }
    },
    (err) => console.log("Location error:", err),
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadZones() {
  try {
    const res = await fetch(`${API_BASE}/api/zones`);
    allZones = await res.json();
    renderZones(allZones);
  } catch (e) {
    console.error("Zones load error:", e);
  }
}

function renderZones(zones) {
  zonesLayer.clearLayers();
  
  const filtered = showOnlyMine
    ? zones.filter(z => String(z.owner_id) === String(userId))
    : zones;

  filtered.forEach(zone => {
    const colors = TEAM_COLORS[zone.team] || TEAM_COLORS.neutral;
    const style = {
      color: colors.border,
      fillColor: colors.fill,
      fillOpacity: 0.35,
      weight: 2,
    };

    let layer;

    if (zone.type === "circle") {
      layer = L.circle([zone.center_lat, zone.center_lng], {
        radius: zone.radius_m,
        ...style,
      });
    } else {
      // polygon
      const geom = zone.geometry;
      if (Array.isArray(geom) && geom.length >= 3) {
        const latlngs = geom.map(p => [p.lat, p.lng]);
        layer = L.polygon(latlngs, style);
      }
    }

    if (layer) {
      layer.on("click", () => showZonePopup(zone));
      layer.addTo(zonesLayer);

      // Zona nomi
      if (zone.owner_name) {
        L.marker([zone.center_lat, zone.center_lng], {
          icon: L.divIcon({
            className: "",
            html: `<div style="
              background: rgba(22,33,62,0.85);
              color:#fff;
              padding: 2px 6px;
              border-radius: 8px;
              font-size: 10px;
              white-space: nowrap;
              border: 1px solid ${colors.border};
            ">${zone.team_emoji} ${zone.owner_name}</div>`,
            iconAnchor: [30, 0],
          }),
        }).addTo(zonesLayer);
      }
    }
  });
}

function showZonePopup(zone) {
  const popup = document.getElementById("zone-popup");
  document.getElementById("popup-title").textContent =
    `${zone.team_emoji} Zona #${zone.id}`;
  document.getElementById("popup-owner").textContent =
    `üë§ Egasi: ${zone.owner_name}`;
  document.getElementById("popup-team").textContent =
    `üéΩ Jamoa: ${zone.team_name}`;
  const area = zone.area_m2 < 10000
    ? `${zone.area_m2.toFixed(0)} m¬≤`
    : `${(zone.area_m2/10000).toFixed(3)} ga`;
  document.getElementById("popup-area").textContent = `üìê Maydon: ${area}`;
  document.getElementById("popup-date").textContent =
    `üìÖ ${zone.created_at?.substring(0, 10) || ""}`;
  popup.style.display = "block";
}

function closePopup() {
  document.getElementById("zone-popup").style.display = "none";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER INFO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadUserInfo() {
  if (!userId) return;
  try {
    const res = await fetch(`${API_BASE}/api/user?user_id=${userId}`);
    if (!res.ok) return;
    const user = await res.json();

    document.getElementById("team-badge").textContent =
      `${user.team_emoji} ${user.team_name}`;
    document.getElementById("stat-zones").textContent = user.zones_owned;
    document.getElementById("stat-km").textContent = user.total_km.toFixed(1);
    document.getElementById("stat-captures").textContent = "-";
  } catch (e) {
    console.error("User info error:", e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUTTONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function centerOnMe() {
  if (currentLat && currentLng) {
    map.setView([currentLat, currentLng], 16);
  } else {
    tg.showAlert("üìç Joylashuvingiz hali aniqlanmadi.");
  }
}

function toggleMyZones() {
  showOnlyMine = !showOnlyMine;
  renderZones(allZones);
  const btn = event.target;
  btn.textContent = showOnlyMine ? "üåç Hammasi" : "üè¥ Menikilar";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  startLiveLocation();
  await Promise.all([loadZones(), loadUserInfo()]);
  document.getElementById("loading").style.display = "none";

  // Har 30 soniyada zonalarni yangilash
  setInterval(loadZones, 30000);
}

init();
</script>

<style>
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 8px #e94560; }
  50% { box-shadow: 0 0 16px #e94560, 0 0 24px #e94560; }
}
</style>
</body>
</html>
